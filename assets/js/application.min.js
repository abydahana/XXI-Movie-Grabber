var app_name									= 'NoAd! Streaming',
	wrapper										= '.listing-placeholder',
	preloader									= '.preloader',
	form										= '.ajax-form',
	input										= '.keyword',
	link										= '.play-movie',
	more_button									= '.load-more-btn',
	currentRequest								= null,
	timeout										= null;

function get(param, url)
{  
	var url										= window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');  
	for(var i = 0; i < url.length; i++)
	{  
		var urlparam							= url[i].split('=');  
		if(urlparam[0] == param)
		{  
			return urlparam[1];  
		}  
	}  
} 

function _load_result(response)
{
	$(input).val(response.title),
	$.each(response.results, function(key, val)
	{
		$(
			'<div class="col-6 col-md-3 col-lg-2">' +
				'<a href="?slug=' + val.slug + (val.serial ? '&s=1' : '') + '" data-slug="' + val.slug + '" data-serial="' + val.serial + '" id="item_' + key + '" class="text-decoration-none text-dark d-block focusable play-movie">' +
					'<div class="thumbnail mb-4" style="background:url(' + val.poster + ') center center no-repeat;background-size:cover">' +
						'<div class="thumbnail-header text-right">' +
							(val.trailer ?
								'<span class="badge badge-danger">TRAILER</span>'
							:
								'<span class="badge badge-info">' + val.rating + '</span>' +
								'<span class="badge badge-dark">' + val.duration + '</span>'
							) +
						'</div>' +
						'<div class="thumbnail-footer text-center text-truncate">' +
							val.title +
						'</div>' +
					'</div>' +
				'</a>' +
			'</div>'
		)
		.appendTo(wrapper)
	}),
	$('.play-movie#item_0').focus(),
	(get('q') && response.next_page ? $('<div class="col-6 col-md-3 col-lg-2 load-more-wrapper"><a href="" class="btn btn-outline-secondary btn-lg focusable d-block load-more-btn" data-next-page="' + response.next_page + '">Load more...</a></div>').appendTo(wrapper) : $('.load-more-btn').remove())
}

function _load_player(response)
{
	var source									= '';
	$.each(response.source, function(key, val)
	{
		source									+= '<source src="' + val + '" />';
	}),
	$('.navbar').fadeOut(),
	$(wrapper).html
	(
		'<video controls>' +
			source +
			
			(response.subtitle ? '<track kind="subtitles" src="apis/subtitle.php?slug=' + response.subtitle + '" srclang="id" />' : null) +
		'</video>'
	),
	$('video, audio').mediaelementplayer
	({
		autoplay: true,
		title: response.title,
		poster: response.poster,
		enableKeyboard: false,
		startLanguage: 'id',
		startVolume: 1,
		toggleCaptionsButtonWhenOnlyOne: true
	})
}

function _throw_exception(response)
{
	if(404 === response)
	{
		$(wrapper).html
		(
			'<div class="container h-100" style="padding-top:100px">' +
				'<div class="row h-100 align-items-center">' +
					'<div class="col-md-6 offset-md-3">' +
						'<h2 class="text-center text-light">' +
							'No movie were found!' +
						'</h2>' +
						'<p class="lead text-center text-light">' +
							'Your search <b class="font-weight-bold">' + get('q') + '</b> didn\'t match any result. Please note that only movie title that used as keyword...' +
						'</p>' +
					'</div>' +
				'</div>' +
			'</div>'
		)
	}
	else if(415 === response)
	{
		$(wrapper).html
		(
			'<div class="container h-100" style="padding-top:100px">' +
				'<div class="row h-100 align-items-center">' +
					'<div class="col-md-6 offset-md-3">' +
						'<h2 class="text-center text-light">' +
							'Playback Error!' +
						'</h2>' +
						'<p class="lead text-center text-light">' +
							'No resource can be found or the requested movie you would to play is already removed...' +
						'</p>' +
					'</div>' +
				'</div>' +
			'</div>'
		)
	}
	else
	{
		/*
		$(wrapper).html
		(
			'<div class="container h-100" style="padding-top:100px">' +
				'<div class="row h-100 align-items-center">' +
					'<div class="col-md-6 offset-md-3">' +
						'<h2 class="text-center text-light">' +
							'Request Failed!' +
						'</h2>' +
						'<p class="lead text-center text-light">' +
							'Something went wrong while processing your request. Please try again...' +
						'</p>' +
					'</div>' +
				'</div>' +
			'</div>'
		)
		*/
	}
}

$(document).ready(function()
{
	$.ajaxSetup
	({
		beforeSend: function(request)
		{
			$('.navbar').fadeIn(),
			$(wrapper).html('<div class="col-md-12 text-center pt-5 preloader"><div class="spinner-border text-light" style="width: 3rem; height: 3rem" role="status"><span class="sr-only">Loading...</span></div></div>');
			
			if(currentRequest)
			{
				currentRequest.abort()
			}
		},
		error: function(request, status, error)
		{
			$(preloader).remove(),
			_throw_exception()
		},
		success: function(response)
		{
			$(preloader).remove()
		}
	}),
	
	$(window).bind("popstate", function(e)
	{
		//if(!e.originalEvent.state) return;
		
		if(location.href.indexOf('?slug=') >= 0)
		{
			currentRequest						= $.ajax
			({
				url: 'apis/single.php',
				method: 'GET',
				data:
				{
					slug: get('slug'),
					serial: get('s')
				},
				context: this
			})
			.done(function(response)
			{
				if(response.status === 200)
				{
					_load_player(response)
				}
				else
				{
					_throw_exception(415)
				}
			})
		}
		else
		{
			currentRequest						= $.ajax
			({
				url: 'apis/search.php',
				method: 'GET',
				data:
				{
					q: get('q'),
					p: get('p')
				},
				context: this
			})
			.done(function(response)
			{
				if(response.status === 200)
				{
					_load_result(response)
				}
				else
				{
					_throw_exception(404)
				}
			})
		}
	}),
	
	$(wrapper).each(function()
	{
		if(location.href.indexOf('?slug=') >= 0)
		{
			currentRequest						= $.ajax
			({
				url: 'apis/single.php',
				method: 'GET',
				data:
				{
					slug: get('slug'),
					serial: get('s')
				},
				context: this
			})
			.done(function(response)
			{
				if(response.status === 200)
				{
					_load_player(response)
				}
				else
				{
					_throw_exception(415)
				}
			})
		}
		else
		{
			currentRequest						= $.ajax
			({
				url: 'apis/search.php',
				method: 'GET',
				data:
				{
					q: (get('q') ? get('q') : localStorage.getItem('keyword')),
					p: get('p')
				},
				context: this
			})
			.done(function(response)
			{
				if(response.status === 200)
				{
					_load_result(response)
				}
				else
				{
					_throw_exception(404)
				}
			})
		}
	}),
	
	$('body').on('submit', form, function(e)
	{
		e.preventDefault();
		
		currentRequest							= $.ajax
		({
			url: 'apis/search.php',
			method: 'GET',
			data:
			{
				q: $(this).find(input).val()
			},
			context: this
		})
		.done(function(response)
		{
			if(response.status === 200)
			{
				history.pushState({path: response.query_string}, (response.title ? response.title + ' | ' : '') + app_name, response.query_string),
				localStorage.setItem('keyword', response.title),				
				_load_result(response)
			}
			else
			{
				_throw_exception(404)
			}
		})
	}),
	
	$('body').on('click', more_button, function(e)
	{
		e.preventDefault();
		
		currentRequest							= $.ajax
		({
			url: 'apis/search.php',
			method: 'GET',
			data:
			{
				q: get('q'),
				p: $(this).attr('data-next-page')
			},
			context: this,
			beforeSend: function()
			{
				if(currentRequest)
				{
					currentRequest.abort()
				}
				return;
			}
		})
		.done(function(response)
		{
			if(response.status === 200)
			{
				$('.load-more-wrapper').remove(),
				history.pushState({path: '?q=' + get('q') + ($(this).attr('data-next-page') ? '&p=' + $(this).attr('data-next-page') : '')}, (response.title ? response.title + ' | ' : '') + app_name, '?q=' + get('q') + ($(this).attr('data-next-page') ? '&p=' + $(this).attr('data-next-page') : '')),
				_load_result(response)
			}
		})
	}),
	
	$('body').on('click touch', link, function(e)
	{
		e.preventDefault();
		
		currentRequest							= $.ajax
		({
			url: 'apis/single.php',
			method: 'GET',
			data:
			{
				slug: $(this).attr('data-slug'),
				serial: $(this).attr('data-serial')
			},
			context: this
		})
		.done(function(response)
		{
			if(response.status === 200)
			{
				history.pushState({path: $(this).attr('href')}, (response.title ? response.title + ' | ' : '') + app_name, $(this).attr('href')),
				_load_player(response)
			}
			else
			{
				_throw_exception(415)
			}
		})
	}),
	
	/**
	 * Remote key mapping
	 */
	$(document).on("keyup", function(e)
	{
		if (e.preventDefault(), 227 === e.which || 177 === e.which || 37 === e.which)
		{
			// nav left
			if (void 0 === (r = document.querySelector("video")).currentTime) return !1;
			r.currentTime += -30;
		}
		else if (228 === e.which || 176 === e.which || 39 === e.which)
		{
			// nav right
			if (void 0 === (r = document.querySelector("video")).currentTime) return !1;
			r.currentTime += 30
		}
		else if (179 === e.which || 32 === e.which || 13 === e.which)
		{
			// ok, space, play / pause
			var r;
			if (!(r = document.querySelector("video"))) return !1;
			$(".mejs__playpause-button").trigger("click")
		}
		else if(38 === e.which)
		{
			// nav up
			if (void 0 === (r = document.querySelector("video")).currentTime) return !1;
		}
		else if(40 === e.which)
		{
			// nav down
			if (void 0 === (r = document.querySelector("video")).currentTime) return !1;
		}
		else
		{
			var r;
			if (!(r = document.querySelector("video"))) return !1;
			$(".mejs__captions-button").trigger("click")
		}
		if(timeout)
		{
			clearTimeout(timeout);
			timeout								= null;
		}
		$('.mejs__controls').removeClass('mejs__offscreen').fadeIn();
		timeout									= setTimeout(function()
		{
			$('.mejs__controls').addClass('mejs__offscreen').fadeOut()
		}, 5000)
	})
})